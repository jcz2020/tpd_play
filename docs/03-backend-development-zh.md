# 后端开发指南

本文档概述了 Acoustic Harmony 应用的服务端架构。

## 1. Server Actions

后端完全使用 **Next.js Server Actions** 构建。没有传统的 REST 或 GraphQL API。

- **位置**: 所有可被客户端访问的服务端逻辑都位于 **`src/lib/actions.ts`**。
- **`'use server';`**: 文件顶部的这个指令将所有导出的函数标记为 Server Actions。这允许它们被直接从客户端组件中导入和调用。
- **安全性**: Next.js 自动处理安全层，确保 Server Actions 在服务器上安全执行，而不是在客户端浏览器中。数据会自动序列化和反序列化。

### `actions.ts` 的主要职责

- **设备通信**: 包含向 B&O 设备的本地 API 发出 HTTP 请求的所有逻辑（例如，获取播放状态、设置音量）。
- **数据库操作**: 通过 `getDb` 和 `saveDb` 工具函数处理所有对 `db.json` 文件的读写操作。
- **文件系统操作**: 管理诸如从本地文件系统扫描音乐文件夹等任务。

在添加新的后端特性时，您几乎总是应该向 `src/lib/actions.ts` 添加一个新的导出的 `async` 函数。

## 2. 数据库

应用使用一个简单的、基于文件的 JSON 数据库进行持久化。

- **文件**: `src/lib/db.json`
- **目的**: 存储需要在服务器重启之间持久化的应用数据，例如：
  - 配置的设备列表。
  - 用户创建的播放列表。
  - 本地音乐文件夹的路径。
  - 缓存的已发现音乐轨道列表。
- **工具**: `src/lib/db.ts` 文件包含两个辅助函数：
  - `getDb()`: 读取并解析 `db.json` 文件。
  - `saveDb(data)`: 将提供的数据对象字符串化并写回 `db.json` 文件。

**注意**: 这是一个非常基础的数据库解决方案。对于具有多个用户或更复杂数据需求的生产应用，应将其替换为更健壮的数据库系统，如 PostgreSQL、MySQL 或基于云的解决方案（如 Firestore）。

## 3. 设备发现服务

由于 Bonjour/mDNS 设备发现是一个长时间运行的异步过程，它不太适合 Web 服务器的标准请求-响应生命周期。为了解决这个问题，我们使用了一个独立的、单独的 Node.js 服务。

- **文件**: `src/lib/discovery-service.ts`
- **目的**: 持续扫描本地网络，寻找广播 `_beoremote._tcp` 服务的 B&O 设备。
- **执行**: 此服务**不**是主 Next.js 应用的一部分。它必须使用命令 `npm run discover` 作为一个单独的进程运行。
- **通信**:
  1. 发现服务在 `http://localhost:9003` 上运行一个 Express 服务器。
  2. 它有一个唯一的端点：`/discover`。
  3. 当主 Next.js 应用需要寻找设备时（例如，在“添加设备”对话框中），它会向 `http://localhost:9003/discover` 发出一个 HTTP GET 请求。
  4. 发现服务返回它目前已找到的设备的 JSON 数组。

这种架构将长时间运行的发现过程与主 Web 应用解耦，提高了稳定性和性能。
